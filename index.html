<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task RPG - Pixel Art</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, linkWithCredential, EmailAuthProvider, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- SUAS CHAVES OFICIAIS ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGVTkVOvS9-y6TpIT1njjfYM6QhR_qZng",
            authDomain: "rpg-task-ffa2b.firebaseapp.com",
            projectId: "rpg-task-ffa2b",
            storageBucket: "rpg-task-ffa2b.firebasestorage.app",
            messagingSenderId: "954731298180",
            appId: "1:954731298180:web:51b57b46042c1ad64ab1d1"
        };

        window.firebase = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, linkWithCredential, EmailAuthProvider, signInWithEmailAndPassword, signOut, getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, getDoc, firebaseConfig };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c0f1d; color: #f8fafc; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .card-base { background: #161b33; border: 4px solid #2d365e; border-radius: 8px; }
        .xp-bar { height: 14px; transition: width 0.3s ease; border: 2px solid #000; }
        .btn-active:active { transform: scale(0.95); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        
        /* Cont√™iner do Cen√°rio 2D Pixel */
        .scene-container {
            width: 100%;
            height: 240px;
            background: #7dd3fc;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid #064e3b;
            image-rendering: pixelated; 
        }

        /* Camadas de Equipamento */
        .layer-hidden { opacity: 0; pointer-events: none; }
        .layer-visible { opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-[#0c0f1d] z-[9999]">
        <p class="pixel-font text-indigo-400 text-xs tracking-widest animate-pulse">CARREGANDO...</p>
    </div>

    <!-- MENSAGENS PERSONALIZADAS -->
    <div id="modal-msg" class="modal-overlay hidden" style="z-index: 2000;">
        <div class="card-base p-8 w-full max-w-[300px] text-center border-4 border-indigo-500 shadow-2xl">
            <h3 id="msg-title" class="text-sm pixel-font mb-6 leading-relaxed"></h3>
            <p id="msg-text" class="text-[10px] pixel-font text-white leading-loose mb-8"></p>
            <button onclick="document.getElementById('modal-msg').classList.add('hidden')" class="w-full bg-indigo-600 py-4 font-black text-white text-[10px] pixel-font border-2 border-indigo-400 btn-active">OK</button>
        </div>
    </div>

    <div id="app-content" class="hidden max-w-2xl mx-auto pb-24">
        
        <header class="flex justify-between items-center mb-6">
            <button onclick="window.toggleSidebar()" class="card-base px-4 py-3 text-white text-[10px] font-bold pixel-font btn-active">MENU</button>
            <h1 class="pixel-font text-indigo-400 text-xs tracking-tighter">TASK RPG</h1>
            <div class="w-10"></div>
        </header>

        <!-- Cart√£o do Her√≥i com Diorama Pixel Art -->
        <div class="card-base mb-8 shadow-2xl overflow-hidden">
            
            <div class="scene-container">
                <svg viewBox="0 0 200 120" width="100%" height="100%" shape-rendering="crispEdges">
                    <!-- C√©u e Sol -->
                    <rect x="0" y="0" width="200" height="120" fill="#7dd3fc" />
                    <rect x="160" y="15" width="16" height="16" fill="#fef08a" />
                    <!-- Nuvens Pixeladas -->
                    <rect x="20" y="20" width="30" height="10" fill="#ffffff" />
                    <rect x="25" y="15" width="20" height="5" fill="#ffffff" />
                    <rect x="120" y="30" width="40" height="12" fill="#ffffff" />
                    <rect x="130" y="25" width="20" height="5" fill="#ffffff" />
                    <!-- Gramado base -->
                    <rect x="0" y="80" width="200" height="40" fill="#22c55e" />
                    <rect x="0" y="80" width="200" height="4" fill="#16a34a" />
                    <!-- Detalhes da grama -->
                    <rect x="15" y="90" width="4" height="2" fill="#15803d" />
                    <rect x="45" y="105" width="6" height="2" fill="#15803d" />
                    <rect x="135" y="95" width="4" height="2" fill="#15803d" />
                    <rect x="175" y="110" width="6" height="2" fill="#15803d" />
                    <!-- √Årvores Esquerda -->
                    <rect x="24" y="40" width="8" height="40" fill="#78350f" />
                    <rect x="12" y="20" width="32" height="20" fill="#166534" />
                    <rect x="16" y="10" width="24" height="10" fill="#166534" />
                    <rect x="20" y="0" width="16" height="10" fill="#166534" />
                    <!-- √Årvores Direita -->
                    <rect x="164" y="40" width="8" height="40" fill="#78350f" />
                    <rect x="152" y="25" width="32" height="15" fill="#166534" />
                    <rect x="156" y="15" width="24" height="10" fill="#166534" />

                    <!-- ITEM CEN√ÅRIO: Tenda -->
                    <g id="layer-sc_tent" class="layer-hidden">
                        <rect x="134" y="56" width="32" height="24" fill="#b45309" />
                        <rect x="138" y="48" width="24" height="8" fill="#b45309" />
                        <rect x="144" y="40" width="12" height="8" fill="#b45309" />
                        <rect x="146" y="66" width="8" height="14" fill="#000000" />
                    </g>

                    <!-- ITEM EQUIP: Capa -->
                    <g id="layer-eq_cape" class="layer-hidden">
                        <rect x="85" y="56" width="30" height="24" fill="#991b1b" />
                    </g>

                    <!-- ITEM EQUIP: Escudo -->
                    <g id="layer-eq_shield" class="layer-hidden">
                        <rect x="82" y="56" width="10" height="14" fill="#4f46e5" />
                        <rect x="84" y="58" width="6" height="10" fill="#64748b" />
                    </g>

                    <!-- AVATAR DO HER√ìI PIXELADO -->
                    <g id="hero-pixel-body">
                        <rect x="90" y="78" width="20" height="4" fill="rgba(0,0,0,0.3)" />
                        <rect x="87" y="56" width="5" height="12" fill="#ffedd5" />
                        <rect x="93" y="72" width="5" height="8" fill="#1e293b" />
                        <rect x="102" y="72" width="5" height="8" fill="#1e293b" />
                        <rect x="92" y="56" width="16" height="16" fill="#3b82f6" />
                        <rect x="94" y="42" width="12" height="14" fill="#ffedd5" />
                        <rect x="94" y="40" width="12" height="4" fill="#451a03" />
                        <rect x="92" y="44" width="4" height="6" fill="#451a03" />
                        <rect x="96" y="48" width="2" height="2" fill="#000000" />
                        <rect x="102" y="48" width="2" height="2" fill="#000000" />
                        <rect x="108" y="56" width="5" height="12" fill="#ffedd5" />
                    </g>

                    <!-- ITEM EQUIP: Espada -->
                    <g id="layer-eq_sword" class="layer-hidden">
                        <rect x="110" y="30" width="3" height="24" fill="#cbd5e1" />
                        <rect x="107" y="54" width="9" height="3" fill="#475569" />
                        <rect x="110" y="57" width="3" height="6" fill="#78350f" />
                    </g>

                    <!-- ITEM EQUIP: Chap√©u -->
                    <g id="layer-eq_hat" class="layer-hidden">
                        <rect x="94" y="26" width="12" height="12" fill="#4f46e5" />
                        <rect x="90" y="38" width="20" height="4" fill="#3730a3" />
                    </g>

                    <!-- ITEM CEN√ÅRIO: Fogueira -->
                    <g id="layer-sc_camp" class="layer-hidden">
                        <rect x="56" y="76" width="16" height="4" fill="#451a03" />
                        <rect x="60" y="66" width="8" height="10" fill="#f97316" />
                        <rect x="62" y="68" width="4" height="8" fill="#fef08a" />
                    </g>

                </svg>
            </div>
            
            <!-- Painel de Estat√≠sticas -->
            <div class="p-5 bg-[#161b33]">
                <div class="flex justify-between items-end mb-5">
                    <div>
                        <h2 id="hero-name" class="text-sm font-bold text-white uppercase pixel-font">Heroi</h2>
                        <p id="hero-email" class="text-[9px] text-slate-400 mt-2 uppercase"></p>
                    </div>
                    <div class="text-right">
                        <span class="text-[8px] uppercase text-emerald-400 pixel-font block mb-2">Lvl</span>
                        <div id="lvl" class="text-xl pixel-font text-white">1</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-5">
                    <div class="bg-[#0c0f1d] p-3 text-center border-2 border-[#2d365e]">
                        <span class="text-[8px] uppercase text-yellow-500 pixel-font block mb-2">Ouro</span>
                        <div id="coins" class="text-sm pixel-font text-yellow-500">0</div>
                    </div>
                    <div class="bg-[#0c0f1d] p-3 text-center border-2 border-[#2d365e]">
                        <span class="text-[8px] uppercase text-orange-500 pixel-font block mb-2">√ìleo</span>
                        <div id="oil" class="text-sm pixel-font text-orange-500">0</div>
                    </div>
                </div>

                <div class="w-full bg-[#0c0f1d] h-4 border-2 border-[#2d365e] p-[2px]">
                    <div id="xp-bar" class="xp-bar bg-emerald-500 h-full w-0"></div>
                </div>
            </div>
        </div>

        <main id="tab-container">
            <!-- Miss√µes -->
            <div id="view-tasks" class="space-y-4">
                <div class="card-base p-5">
                    <h3 class="text-[10px] pixel-font text-slate-300 mb-4">NOVA TAREFA</h3>
                    <input type="text" id="t-input" placeholder="O que vai fazer?" class="w-full bg-[#0c0f1d] p-4 mb-3 outline-none border-2 border-[#2d365e] text-white text-sm">
                    <div class="flex gap-2">
                        <select id="t-diff" class="bg-[#0c0f1d] p-4 flex-1 text-xs font-bold text-emerald-300 border-2 border-[#2d365e]">
                            <option value="easy">F√°cil</option>
                            <option value="medium">M√©dia</option>
                            <option value="hard">Dif√≠cil</option>
                        </select>
                        <button onclick="window.addTask()" class="bg-emerald-600 px-6 font-black btn-active text-white text-[10px] pixel-font border-2 border-emerald-400">ADD</button>
                    </div>
                </div>
                <div id="t-list" class="space-y-3"></div>
            </div>

            <!-- H√°bitos -->
            <div id="view-habits" class="hidden space-y-4">
                <div class="card-base p-5">
                    <h3 class="text-[10px] pixel-font text-slate-300 mb-4">NOVO H√ÅBITO</h3>
                    <div class="flex gap-2">
                        <input type="text" id="h-input" placeholder="Ex: Ler..." class="flex-1 bg-[#0c0f1d] p-4 border-2 border-[#2d365e] outline-none text-white text-sm">
                        <button onclick="window.addHabit()" class="bg-orange-600 px-6 font-black btn-active text-white text-[10px] pixel-font border-2 border-orange-400">ADD</button>
                    </div>
                </div>
                <div id="h-list" class="space-y-3"></div>
            </div>

            <!-- Foco -->
            <div id="view-foco" class="hidden text-center card-base p-10">
                <h3 class="text-sm pixel-font mb-4 text-orange-500">MODO FOCO</h3>
                <p class="text-[10px] text-slate-400 mb-8 pixel-font leading-loose">Trabalhe duro<br>ganhe √≥leo</p>
                <div id="timer" class="text-4xl pixel-font mb-10 text-white">20:00</div>
                <button id="timer-btn" onclick="window.toggleTimer()" class="w-full bg-orange-600 py-5 font-black text-[12px] pixel-font text-white border-4 border-orange-400 btn-active">COME√áAR</button>
            </div>

            <!-- Loja -->
            <div id="view-store" class="hidden space-y-4">
                <h3 class="text-[12px] pixel-font mb-4 text-yellow-500 text-center bg-[#0c0f1d] p-4 border-2 border-[#2d365e]">LOJA DE ITENS</h3>
                <div id="store-list" class="grid gap-3"></div>
            </div>

            <!-- Invent√°rio -->
            <div id="view-inventory" class="hidden space-y-4">
                <h3 class="text-[12px] pixel-font mb-4 text-emerald-400 text-center bg-[#0c0f1d] p-4 border-2 border-[#2d365e]">MOCHILA</h3>
                <div id="inv-list" class="grid grid-cols-2 gap-3"></div>
            </div>

            <!-- Quiz (Atualizado com L√≥gica Di√°ria) -->
            <div id="view-quiz" class="hidden text-center card-base p-8">
                <h3 class="text-[12px] pixel-font mb-8 text-indigo-400">QUIZ DI√ÅRIO</h3>
                <div id="quiz-ui">
                    <p id="q-text" class="text-[11px] mb-8 font-bold text-white leading-relaxed pixel-font"></p>
                    <div id="q-options" class="grid gap-4"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/80 z-40 hidden" onclick="window.toggleSidebar()"></div>
    <div id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#161b33] z-50 transform -translate-x-full transition-transform duration-300 p-8 flex flex-col border-r-4 border-[#2d365e]">
        <h3 class="text-sm pixel-font text-emerald-400 mb-10">MENU</h3>
        <nav class="flex-1 space-y-3">
            <button onclick="window.switchTab('tasks')" class="w-full text-left p-3 hover:bg-[#0c0f1d] font-bold text-white text-[10px] pixel-font">‚öîÔ∏è MISS√ïES</button>
            <button onclick="window.switchTab('habits')" class="w-full text-left p-3 hover:bg-[#0c0f1d] font-bold text-white text-[10px] pixel-font">üî• H√ÅBITOS</button>
            <button onclick="window.switchTab('foco')" class="w-full text-left p-3 hover:bg-[#0c0f1d] font-bold text-white text-[10px] pixel-font">üßò FOCO</button>
            <button onclick="window.switchTab('quiz')" class="w-full text-left p-3 hover:bg-[#0c0f1d] font-bold text-white text-[10px] pixel-font">üß† QUIZ</button>
            <button onclick="window.switchTab('store')" class="w-full text-left p-3 hover:bg-[#0c0f1d] font-bold text-yellow-400 text-[10px] pixel-font">üí∞ LOJA</button>
            <button onclick="window.switchTab('inventory')" class="w-full text-left p-3 hover:bg-[#0c0f1d] font-bold text-emerald-400 text-[10px] pixel-font">üéí MOCHILA</button>
            
            <div class="pt-6 mt-6 border-t-2 border-[#2d365e]">
                <button onclick="window.openAuth('link')" class="w-full p-4 bg-indigo-600 font-black text-white text-[8px] pixel-font btn-active mb-3 border-2 border-indigo-400">üîó SALVAR CONTA</button>
                <button onclick="window.openAuth('login')" class="w-full p-4 bg-[#0c0f1d] text-indigo-400 font-bold text-[8px] pixel-font border-2 border-[#2d365e] btn-active">üîë LOGIN</button>
                <button id="logout-btn" onclick="window.handleLogout()" class="hidden w-full p-4 bg-red-900/30 text-red-400 font-bold text-[8px] pixel-font mt-3 border-2 border-red-900/50">üö™ SAIR</button>
            </div>
        </nav>
    </div>

    <!-- Modal Auth -->
    <div id="modal-auth" class="modal-overlay hidden">
        <div class="card-base p-8 w-full max-w-[340px] text-center">
            <h3 id="modal-title" class="text-sm pixel-font mb-6 text-indigo-400">VINCULAR</h3>
            <input type="email" id="auth-email" placeholder="E-mail" class="w-full p-4 bg-[#0c0f1d] border-2 border-[#2d365e] mb-4 text-xs text-white outline-none">
            <input type="password" id="auth-pass" placeholder="Senha" class="w-full p-4 bg-[#0c0f1d] border-2 border-[#2d365e] mb-8 text-xs text-white outline-none">
            <button id="auth-btn" onclick="window.handleAuth()" class="w-full bg-green-600 py-4 font-black text-white text-[10px] pixel-font border-2 border-green-400 btn-active mb-4">CONFIRMAR</button>
            <button onclick="window.closeAuth()" class="w-full py-4 text-slate-500 text-[10px] pixel-font btn-active">CANCELAR</button>
        </div>
    </div>

    <script type="module">
        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, linkWithCredential, EmailAuthProvider, signInWithEmailAndPassword, signOut, getFirestore, doc, setDoc, onSnapshot, collection, addDoc, deleteDoc, firebaseConfig } = window.firebase;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = "rpg-task-pixel-static-v1"; 

        let user = null, stats = {}, tasks = [], habits = [], inventory = {}, equipped = [], timerInt = null, authMode = 'link';

        const STORE_ITEMS = [
            { id: 'eq_sword', name: 'Espada Pixel', price: 100, icon: '‚öîÔ∏è', type: 'Equipamento', slot: 'hand' },
            { id: 'eq_hat', name: 'Elmo Azul', price: 150, icon: 'ü™ñ', type: 'Equipamento', slot: 'head' },
            { id: 'eq_shield', name: 'Escudo Base', price: 120, icon: 'üõ°Ô∏è', type: 'Equipamento', slot: 'offhand' },
            { id: 'eq_cape', name: 'Capa Vermelha', price: 250, icon: 'üß£', type: 'Equipamento', slot: 'back' },
            { id: 'sc_camp', name: 'Fogueira', price: 200, icon: 'üî•', type: 'Cen√°rio', slot: 'scene_fg' },
            { id: 'sc_tent', name: 'Tenda', price: 400, icon: '‚õ∫', type: 'Cen√°rio', slot: 'scene_bg' }
        ];

        // --- SISTEMA DE MENSAGENS ---
        window.showMessage = (title, text, colorClass = "text-indigo-400") => {
            const titleEl = document.getElementById('msg-title');
            titleEl.textContent = title;
            titleEl.className = `text-[12px] pixel-font mb-4 ${colorClass}`;
            document.getElementById('msg-text').innerHTML = text;
            document.getElementById('modal-msg').classList.remove('hidden');
        };

        // --- Atualiza√ß√£o Visual ---
        function update2DVisuals() {
            document.querySelectorAll('.layer-visible').forEach(el => {
                el.classList.remove('layer-visible');
                el.classList.add('layer-hidden');
            });
            equipped.forEach(id => {
                const layer = document.getElementById(`layer-${id}`);
                if(layer) {
                    layer.classList.remove('layer-hidden');
                    layer.classList.add('layer-visible');
                }
            });
        }

        // --- Auth ---
        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('hero-email').textContent = u.isAnonymous ? "Convidado" : u.email.split('@')[0];
                document.getElementById('logout-btn').classList.toggle('hidden', u.isAnonymous);
                startSync();
            } else signInAnonymously(auth);
        });

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            if(!email || pass.length < 6) return window.showMessage("ERRO", "A senha precisa ter no m√≠nimo 6 caracteres.", "text-red-500");
            try {
                if(authMode === 'link') {
                    await linkWithCredential(auth.currentUser, EmailAuthProvider.credential(email, pass));
                    window.showMessage("SUCESSO", "Her√≥i salvo na nuvem com seguran√ßa!", "text-emerald-400");
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
                setTimeout(() => location.reload(), 2000);
            } catch (err) {
                if(err.code === 'auth/provider-already-linked' || err.code === 'auth/email-already-in-use') {
                    if(confirm("E-mail j√° tem um Her√≥i! Fazer LOGIN?")) window.openAuth('login');
                } else window.showMessage("ERRO", err.message, "text-red-500");
            }
        };

        window.handleLogout = async () => { if(confirm("Deseja sair?")) { await signOut(auth); location.reload(); }};

        // --- Sincroniza√ß√£o ---
        function startSync() {
            onSnapshot(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), (s) => { 
                if(s.exists()) {
                    stats = s.data();
                } else {
                    stats = { lvl: 1, xp: 0, coins: 150, oil: 0 };
                    setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), stats);
                }
                updateUI(); 
            });
            onSnapshot(collection(db, `artifacts/${appId}/users/${user.uid}/tasks`), (s) => { tasks = s.docs.map(d => ({id: d.id, ...d.data()})); renderTasks(); });
            onSnapshot(collection(db, `artifacts/${appId}/users/${user.uid}/habits`), (s) => { habits = s.docs.map(d => ({id: d.id, ...d.data()})); renderHabits(); });
            onSnapshot(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'inventory'), (s) => { inventory = s.exists() ? s.data() : {}; renderStore(); renderInventory(); });
            onSnapshot(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'equipped'), (s) => { equipped = s.exists() ? s.data().items : []; update2DVisuals(); renderInventory(); });
        }

        function updateUI() {
            document.getElementById('lvl').textContent = stats.lvl || 1;
            document.getElementById('coins').textContent = stats.coins || 0;
            document.getElementById('oil').textContent = stats.oil || 0;
            const xpMax = (stats.lvl || 1) * 100;
            document.getElementById('xp-bar').style.width = `${((stats.xp || 0) / xpMax) * 100}%`;
        }

        // --- Miss√µes ---
        window.addTask = async () => {
            const name = document.getElementById('t-input').value;
            const diff = document.getElementById('t-diff').value;
            if(!name) return;
            await addDoc(collection(db, `artifacts/${appId}/users/${user.uid}/tasks`), { name, diff, createdAt: Date.now() });
            document.getElementById('t-input').value = "";
        };

        function renderTasks() {
            document.getElementById('t-list').innerHTML = tasks.length === 0 ? '<p class="text-center py-6 text-slate-500 text-[10px] pixel-font">Nada a fazer.</p>' : 
            tasks.map(t => `<div class="bg-[#0c0f1d] p-4 flex justify-between items-center border-2 border-[#2d365e]"><div><p class="font-bold text-white text-sm mb-1">${t.name}</p><span class="text-[8px] pixel-font text-emerald-400">${t.diff}</span></div><button onclick="window.completeTask('${t.id}', '${t.diff}')" class="bg-emerald-600 px-4 py-3 font-black text-[8px] pixel-font btn-active border-2 border-emerald-400 text-white">FEITO</button></div>`).join('');
        }

        window.completeTask = async (id, diff) => {
            const gain = diff === 'easy' ? 10 : (diff === 'medium' ? 25 : 50);
            let nxp = (stats.xp || 0) + gain, nlvl = (stats.lvl || 1);
            let lvlUp = false;
            if(nxp >= nlvl * 100) { nxp = 0; nlvl++; lvlUp = true; }
            await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), { ...stats, xp: nxp, lvl: nlvl, coins: (stats.coins || 0) + Math.floor(gain/2) });
            await deleteDoc(doc(db, `artifacts/${appId}/users/${user.uid}/tasks`, id));
            if(lvlUp) window.showMessage("SUBIU DE N√çVEL!", `Voc√™ alcan√ßou o N√≠vel <span class='text-emerald-400 text-lg'>${nlvl}</span>!`, "text-emerald-400");
        };

        // --- H√°bitos ---
        window.addHabit = async () => {
            const n = document.getElementById('h-input').value;
            if(n) { await addDoc(collection(db, `artifacts/${appId}/users/${user.uid}/habits`), { name: n, streak: 0, lastCheck: 0 }); document.getElementById('h-input').value = ""; }
        };
        function renderHabits() {
            document.getElementById('h-list').innerHTML = habits.map(h => `<div class="bg-[#0c0f1d] p-4 flex justify-between items-center border-2 border-[#2d365e]"><div><p class="font-bold text-white text-sm mb-1">${h.name}</p><span class="text-[8px] pixel-font text-orange-400">COMBO: ${h.streak}</span></div><button onclick="window.checkHabit('${h.id}')" class="bg-orange-600 px-4 py-3 font-black text-white text-[8px] pixel-font btn-active border-2 border-orange-400">CHECK</button></div>`).join('');
        }
        window.checkHabit = async (id) => {
            const h = habits.find(i => i.id === id);
            if(h.lastCheck >= new Date().setHours(0,0,0,0)) return window.showMessage("AVISO", "Voc√™ j√° completou este h√°bito hoje!<br><br>Volte amanh√£.", "text-orange-400");
            await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/habits`, id), { ...h, streak: h.streak + 1, lastCheck: Date.now() });
            await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), { ...stats, coins: (stats.coins || 0) + 5, xp: (stats.xp || 0) + 5 });
        };

        // --- Foco e L√ìGICA DO QUIZ DI√ÅRIO ---
        window.toggleTimer = () => {
            if(timerInt) { clearInterval(timerInt); timerInt = null; document.getElementById('timer').textContent = "20:00"; document.getElementById('timer-btn').textContent = "COME√áAR"; return; }
            let s = 20 * 60;
            document.getElementById('timer-btn').textContent = "PARAR";
            timerInt = setInterval(async () => {
                s--; document.getElementById('timer').textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
                if(s <= 0) { 
                    clearInterval(timerInt); timerInt = null; 
                    await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), { ...stats, oil: (stats.oil || 0) + 1 }); 
                    window.showMessage("FOCO COMPLETO!", "Sess√£o finalizada com sucesso.<br><br><span class='text-orange-400 text-lg'>+1 √ìLEO</span>", "text-orange-400");
                    window.toggleTimer(); 
                }
            }, 1000);
        };

        const QUIZ = [
            {q:"O que voc√™ ganha ao fazer Miss√µes?", o:["Ouro e XP", "Apenas √ìleo", "Nada"], a:0}, 
            {q:"Qual √© a finalidade da Tenda na Loja?", o:["Decora√ß√£o do cen√°rio", "Dormir e Pular N√≠vel", "Gastar √ìleo"], a:0},
            {q:"Como se consegue √ìleo no jogo?", o:["Fazendo Miss√µes", "Modo Foco", "Comprando na Loja"], a:1},
            {q:"Para que serve o Ouro?", o:["Comprar Itens na Loja", "Para enfeitar a tela", "Para nada"], a:0},
            {q:"O que significa o 'Combo' nos H√°bitos?", o:["Dias seguidos conclu√≠dos", "Seu N√≠vel Atual", "A sua for√ßa"], a:0}
        ];
        
        window.initQuiz = () => {
            const today = new Date().toDateString();
            let qCount = stats.quizCount || 0;
            let qDate = stats.quizDate || "";

            // Reseta a contagem se for um novo dia
            if (qDate !== today) {
                qCount = 0;
            }

            // Verifica se j√° respondeu as 3 do dia
            if (qCount >= 3) {
                document.getElementById('q-text').innerHTML = "<span class='text-emerald-400'>MISS√ÉO CUMPRIDA!</span><br><br>Voc√™ j√° respondeu os desafios de hoje.<br><br>Volte amanh√£ para mais ouro e sabedoria.";
                document.getElementById('q-options').innerHTML = "";
                return;
            }

            // Renderiza a pergunta
            const q = QUIZ[Math.floor(Math.random() * QUIZ.length)];
            document.getElementById('q-text').textContent = `[${qCount + 1}/3] ${q.q}`;
            document.getElementById('q-options').innerHTML = q.o.map((o, i) => `<button onclick="window.answerQuiz(${i === q.a})" class="bg-[#0c0f1d] p-5 border-2 border-[#2d365e] text-white font-bold btn-active text-[10px] pixel-font">${o}</button>`).join('');
        };
        
        window.answerQuiz = async (win) => { 
            try {
                const today = new Date().toDateString();
                let qCount = (stats.quizDate === today) ? (stats.quizCount || 0) : 0;
                qCount++; // Incrementa as respostas do dia

                let gainCoins = 0;
                let gainXp = 0;
                let nxp = stats.xp || 0;
                let nlvl = stats.lvl || 1;
                let lvlMsg = "";

                if(win) { 
                    gainCoins = 20;
                    gainXp = 10;
                    nxp += gainXp;
                    if(nxp >= nlvl * 100) { 
                        nxp = 0; nlvl++; 
                        lvlMsg = "<br><br><span class='text-emerald-400'>VOC√ä SUBIU DE N√çVEL!</span>";
                    }
                    window.showMessage("MUITO BEM!", `Resposta Correta!<br><br><span class='text-yellow-400 text-sm'>+${gainCoins} OURO</span><br><span class='text-indigo-400 text-sm'>+${gainXp} XP</span>${lvlMsg}`, "text-emerald-400");
                } else {
                    window.showMessage("N√ÉO FOI DESSA VEZ...", "A resposta estava errada.<br><br>Mas a sua coragem √© admir√°vel!", "text-red-500");
                }
                
                // Salva no banco de dados (Ouro, XP, e status do Quiz de hoje)
                stats.quizCount = qCount;
                stats.quizDate = today;
                stats.coins = (stats.coins || 0) + gainCoins;
                stats.xp = nxp;
                stats.lvl = nlvl;

                await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), stats);
                
                // Recarrega o layout do quiz para mostrar a pr√≥xima pergunta ou o aviso "Volte amanh√£" (Sem mudar de aba!)
                window.initQuiz();
                
            } catch (e) {
                window.showMessage("ERRO", e.message, "text-red-500");
            }
        };

        // --- Loja e Mochila ---
        function renderStore() {
            document.getElementById('store-list').innerHTML = STORE_ITEMS.map(i => {
                const owned = inventory[i.id];
                return `<div class="bg-[#0c0f1d] p-4 flex justify-between items-center border-2 border-[#2d365e]">
                    <div class="flex items-center gap-3"><span class="text-3xl">${i.icon}</span><div><p class="font-bold text-white text-sm mb-1">${i.name}</p><span class="text-[8px] pixel-font text-slate-400">${i.type}</span></div></div>
                    <button onclick="window.buyItem('${i.id}', ${i.price})" ${owned?'disabled':''} class="bg-yellow-600 text-black px-4 py-3 font-black text-[8px] pixel-font disabled:opacity-30 btn-active border-2 border-yellow-400">${owned ? 'OK' : 'üí∞ ' + i.price}</button>
                </div>`;
            }).join('');
        }
        window.buyItem = async (id, p) => {
            if(stats.coins < p) return window.showMessage("FALTOU OURO", "Voc√™ n√£o tem moedas suficientes.", "text-yellow-500");
            const n = { ...inventory }; n[id] = true;
            await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'stats'), { ...stats, coins: stats.coins - p });
            await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'inventory'), n);
            window.showMessage("COMPRA SUCESSO!", "O item j√° est√° na sua Mochila.", "text-emerald-400");
        };

        function renderInventory() {
            const items = Object.keys(inventory).filter(id => inventory[id]);
            document.getElementById('inv-list').innerHTML = items.length === 0 ? '<p class="col-span-2 text-center py-6 text-slate-500 text-[10px] pixel-font">Vazia</p>' : 
            items.map(id => {
                const item = STORE_ITEMS.find(i => i.id === id);
                const isEq = equipped.includes(id);
                return `<div class="bg-[#0c0f1d] p-4 text-center border-2 ${isEq ? 'border-emerald-500' : 'border-[#2d365e]'}">
                    <div class="text-4xl mb-3">${item.icon}</div>
                    <p class="font-bold text-[9px] pixel-font text-white mb-4">${item.name}</p>
                    <button onclick="window.toggleEquip('${id}', '${item.slot}')" class="w-full py-3 text-[8px] font-black text-white pixel-font btn-active border-2 ${isEq ? 'bg-red-600 border-red-400' : 'bg-emerald-600 border-emerald-400'}">${isEq ? 'TIRAR' : 'USAR'}</button>
                </div>`;
            }).join('');
        }

        window.toggleEquip = async (id, slot) => {
            let n = [...equipped];
            if(n.includes(id)) {
                n = n.filter(i => i !== id);
            } else {
                const current = n.filter(eqId => STORE_ITEMS.find(s => s.id === eqId)?.slot === slot);
                n = n.filter(eqId => !current.includes(eqId));
                n.push(id);
            }
            await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}/data`, 'equipped'), { items: n });
        };

        // --- INTERFACE ---
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); };
        window.switchTab = (t) => { ['tasks', 'habits', 'foco', 'quiz', 'store', 'inventory'].forEach(v => document.getElementById(`view-${v}`).classList.toggle('hidden', v !== t)); if(t === 'quiz') window.initQuiz(); window.toggleSidebar(); };
        window.openAuth = (m) => { authMode = m; document.getElementById('modal-auth').classList.remove('hidden'); document.getElementById('modal-title').textContent = m === 'link' ? "VINCULAR" : "LOGIN"; window.toggleSidebar(); };
        window.closeAuth = () => document.getElementById('modal-auth').classList.add('hidden');
    </script>
</body>
</html>


